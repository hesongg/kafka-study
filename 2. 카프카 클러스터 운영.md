# 2. 카프카 클러스터 운영 방법
## 인프런 - "[아파치 카프카 애플리케이션 프로그래밍] 개념부터 컨슈머, 프로듀서, 커넥트, 스트림즈까지!" 를 보고 정리한 내용

<br>

### 카프카 클러스터를 운영하는 방법

- 아파치 카프카 클러스터를 서버에 직접 설치하고 운영하는 것은 기본적인 방법이다.
    - 각종 설정을 직접 컨트롤 하여 세부적인 서버 설정을 통해 최고의 성능으로 최적의 클러스터 활용 가능
- 그러나 최적화된 카프카 클러스터 사용을 위해서는 노하우가 필요하기 때문에 수많은 시행착오를 거쳐야 한다.
    - ex) 각종 보안 설정이나 모니터링 도구 설치 및 운영 등..
- 이러한 운영상 시행착오를 줄이면서 최고의 카프카 클러스터를 빠르게 설치하여 안전하게 운영하기 위해 Saas(Software-as-a-Service) 도입 가능

<br>

#### 운영 방법에 따른 서비스 형태들

- <img width="418" alt="image" src="https://github.com/hesongg/kafka-study/assets/77953474/9c25cc52-c49f-44eb-a8b5-3221d17d49de">

- 온프레미스 (on-premise)
- Iaas (Infrastructure-as-a-Service)
    - 인프라 제공
- Paas (Platform-as-a-Service)
    - 런타임 제공
- Saas (Software-as-a-Service)
    - 모든 서비스 제공

- Saas 란?
    - 클라우드 서비스 제공업체가 소프트웨어와 인프라를 관리하고 플랫폼을 제공하는 것
    - 사용자는 웹 대시보드나 CLI 를 통해 플랫폼의 세부 설정을 간편하게 가능
    - 네트워크, 스토리지, 가상화 등 다양한 종류의 운영상 이슈는 업체에서 관리하기 때문에 편리하다.
 
<br>

#### 설치 방법별 서비스 형태 종류

- 온프레미스
    - 자체적으로 보유한 전산실 서버에 직접 설치해서 운영
    - 기업 상황에 맞게 하드웨어 커스터마이징 구성 가능
    - 초기 도입 비용, 운영 및 관리를 위한 유지보수 비용 발생
- IaaS
    - 물리/가상 컴퓨팅 리소스를 발급받아서 사용
    - 온라인 스토리지, 데이터베이스 등도 포함됨
    - 사용자가 운영체제, 애플리케이션 등을 직접 설정, 배포, 운영
- Paas
    - 애플리케이션 개발 및 실행 환경을 제공
    - 사용자는 컴퓨팅 리소스 관리를 신경 쓰지 않아도 됨 
- Saas
    - 소프트웨어의 배포, 실행을 업체에서 관리하고 기능을 제공
    - 소프트웨어 관리를 업체에 위임하고 기능만 사용할 때 유용함

<br>

#### 서비스 형태별 카프카 운영 방법

- 온프레미스
    - 물리장비 구매 및 네트워크 설치 구성
    - 물리장비 운영체제 설치
    - 오픈소스 카프카 설치 및 운영
        - 또는 기업용 카프카(컨플루언트 플랫폼 등) 설치 및 운영
    - 오픈소스 카프카?
        - 아파치 무료 오픈소스 카프카
    - 기업용 카프카?
        - 유료, 튜닝이 되어있음
            - ex) 여러 DB 별로 커스터마이징된 커텍터 제공, 모니터링툴 제공 등
- IaaS
    - AWS, GCP 와 같은 클라우드 서비스를 통해 물리/가상 컴퓨팅 리소스를 발급
    - 컴퓨팅 리소스에 오픈소스 카프카 설치 및 운영
- Saas
    - 컨플루언트 클라우드 또는 AWS MSK 는 대표적인 SaaS
    - 다양한 주변 생태계(ksqlDB, 모니터링 도구 등)를 옵션으로 제공

<br>

#### 오픈 소스 카프카를 직접 설치하여 운영하는 경우

- IaaS 또는 온프레미스 환경에서 카프카 클러스터를 설치하여 운영하는 것이 가장 흔한 운영 방식
- 카프카는 전송된 데이터를 모두 파일 시스템에 저장하고 대규모 데이터 통신이 일어나기 때문에 고성능의 하드웨어를 사용해야한다.
- 컨플루언트에서는 상용 환경의 카프카 클러스터 운영시 브로커의 하드웨어를 다음과 같이 설정하는 것을 추천
    - <img width="672" alt="image" src="https://github.com/hesongg/kafka-study/assets/77953474/f7aecd1d-e57a-425e-96d8-e7c4458e4bee">
    - 힙 메모리 제외 나머지 영역에서는 프로듀서와 컨슈머가 직접적으로 데이터를 주고받을 때 사용하는 (OS ) 페이지 캐시 영역으로 활용된다.

<br>

- <img width="756" alt="image" src="https://github.com/hesongg/kafka-study/assets/77953474/0fd70f38-f387-4dad-ac9a-8afb660c3f56">
- 브로커 replication 관련하여..
    - producer 의 acks 옵션이나 topic 의 min.insync.replicas 이런 옵션들이 정상적으로 처리가 되는지 알려면 브로커가 많은게 테스트하기 용이하다.
    - 최소 3대 ~ 5대로 구성하는게 좋음
- 데이터가 많아지는 경우
    - 브로커를 추가로 구성하여 데이터 처리량을 scalable 하게 구성할 수 있다.

<br>

### SaaS형 아파치 카프카 소개

#### 클라우드 서비스 - 컨플루언트

- 컨플루언트 = 오픈소스 + 알파
- connector 플러그인, ksqlDB, rest proxy 등의 오픈 소스도 제공

- 컨플루언트 클라우드 (SaaS)
    - 클라우드 기반 카프카 클러스터
    - 요구사항에 따라 자동으로 늘려주는 클러스터 리소스 제공
    - GCP, AWS 등 클러스터 설치 위지 지정(리전 단위) 가능
    - 120개가 넘는 커넥터, ksqlDB, 스키마 레지스트리 서비스 제공
    - 99.95% SLA
    - 엔터프라이즈 수준의 보안 수준 제공
    - 데이터 적재 제한 없음
- 컨플루언트 플랫폼 (설치형)
    - 온프레미스 기반 설치형 카프카 클러스터
    - 서버를 내부에서 발급하여 직접 설치
    - 필요에 따라 컨플루언트 팀에서 지원, 학습 제공
    - 단계별 스토리지 기능(Tiered-storage) 제공
    - GUI 기반 모니터링 시스템 제공

<br>

#### 클라우드 서비스 - AWS MSK

- AWS 에서 제공하는 SaaS형 아파치 카프카 서비스
- AWS MSK 는 AWS 인프라에서 카프카 클러스터 생성, 업데이트, 삭제 등의 운영 요소를 대시보드로 제공
- 안전하게 접속 가능하도록 클러스터와 연동시 TLS 인증 보안 설정 가능
- 아파치 카프카 버전 선택 가능
- MSK 는 AWS 에서 운영하는 애플리케이션과 쉽게 연동 가능
- AWS 를 이미 사용 중인 경우 도입하기 쉬움

<br>

### SaaS형 아파치 카프카 장점과 단점

#### SaaS 로 카프카 클러스터를 운영할 경우 장점

- 인프라 관리의 효율화
    - 카프카 클러스터는 상용환경에서 최소 3대 이상의 서버로 운영 (최소 브로커 및 주키퍼 3대 -> 6대의 서버)
        - 모니터링 비용이 있다.
        - SaaS 를 사용하는 경우 인프라 운영 관리 역할에서 자유로움
            - 브로커가 올라가는 서버를 자동으로 관리
    - 특정 브로커에 문제가 발생한다면 신규 장비에 브로커를 실행하여 클러스터 복구
    - SaaS 의 대시보드에서 브로커 개수만 설정하면 쉽게 스케일 아웃 가능

- 모니터링 대시보드 제공
    - 브로커들이 제공하는 지표들을 수집하고 적재 및 대시보드화하여 데이터를 시각화해야 카프카 클러스터를 효과적으로 운영하기위한 필요한 설정들을 수정하고 적용할 수 있다.
    - SaaS형 카프카에서는 자동화되어 만들어진 클러스터로부터 운영에 필요한 지표들을 수집하고 그래프로 보여주는 옵션이 제공

- 보안 설정
    - 보안이 설정 되지않은 클러스터의 경우 호스트와 포트 번호만 알면 모든 토픽의 데이터를 가져갈 수 있다.
    - 또한 어드민API를 통해 카프카 클러스터에 악의적인 공격을 할 수도 있다
    - 카프카 브로커는 SSL, SASL, ACL 과 같이 불특정 다수의 침입을 막기 위해 다양한 종류의 보안 설정 방안을 제공하고 있다.
    - 어떤 종류의 보안설정을 할지 설정, 운영하는 것은 쉽지않다.
        - SaaS형 카프카에서는 클러스터 접속 시의 보안 설정을 기본으로 제공함
        - 클러스터 생성 시 보안 설정을 통해 인가된 사용자만 카프카 클러스터에 접근할 수 있도록 가능

<br>

#### SaaS 로 카프카 클러스터를 운영할 경우 단점

- 서비스 사용 비용
    - 카프카 클러스터 직접 설치 시에는 브로커 및 주키퍼를 실행하는 서버의 사용 비용만 발생
    - 비용 문제 ex) AWS MSK
    - 3대의 브로커로 인스턴스(kafka.m5.xlarge: CPU 4, 메모리 16G)로 구성하면 한달에 1,080 달러의 비용 발생
        - 동일 사양의 인스턴스를 3대 직접 발급하여 설치, 운영하면 2배이상 저렴하다.

- 커스터마이징의 제한
    - 카프카 클러스터 직접 운영 시 서버의 최적화 옵션이나 카프카 브로커 옵션같은 다양한 부분에 사용자 설정이 들어감
    - SaaS 서비스들은 인프라부터 애플리케이션 설치까지 자동화되어있어서 상세한 설정이나 클러스터 아키텍처의 변화가 필요한 경우 적용이 어렵다
    - 특히 멀티 클라우드(2개 이상의 퍼블릭 클라우드 함께 사용) / 하이브리드 클라우드(사내 서버와 퍼블릭 클라우드 함께 사용) 형태로 카프카 클러스터 구성하는 것은 SaaS형 카프카에서 불가능
    - 클라우드 종속성을 탈피하는 목적 / 마이그레이션 목적으로 다른 클라우드 형태의 클러스터로 구성해야할 때 SaaS형 카프카를 사용하고 있다면 매우 복잡해진다.

- 클라우드의 종속성
    - SaaS형 카프카 구축을 위해서는 클라우드 서비스 업체를 선택하고 클러스터를 운영해야함
    - 모든 카프카 애플리케이션이 해당 서비스에 종속된다.
    - SaaS형 카프카 도입 시에는 추후 발생할 수 있는 이슈를 예측해보고 서비스에 미치는 위험 정도를 확인 후 도입해야한다.

- 그럼에도 SaaS형 카프카를 사용하는 것이 나은 경우?
    - 카프카 클러스터에 대한 운영 노하우가 부족한 상태
    - 다만 SaaS형 카프카도 결국 카프카를 설치하여 구성하는 클러스터이므로 카프카에 대한 노하우가 없다면 세세한 운영 부분에 있어서는 어려움이 발생 가능
    - SaaS형 카프카 도입 시에는 현재 인력의 카프카 클러스터 운영에 대한 이해도, 클러스터 구축 비용, 추후 운영상 이슈 등을 다각도로 검토해야함




